<!DOCTYPE html>
<html>
  <head>
    <title>Balls v0.2</title>
    <style>
#canvas {
  border: 2px solid black;
}
body {
  font-family: Arial;
}
#loader {
  position: absolute;
  left: 0px;
  top: 0px;
  width: 100%;
  height: 100%;
  z-index: 5;
  background-color: #ffffff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
.start {
  border-radius: 10px;
  padding: 5px;
  font-size: 50px;
  font-family: sans-serif;
  margin: 5px;
  text-align: center;
}
.start:focus {outline:0;}
    </style>
  </head>
  <body>
    <div id="loader">
      <h1 class='start'>Balls</h1>
      <input type="text" placeholder="Nickname" id="nickname" class='start'></input>
      <select name="color" id="color" class='start'>
        <option value="red">Red</option>
        <option value="blue">Blue</option>
      </select>
      <input type="button" value="Play" id="play" class='start'></input>
    </div>
    <p id="id"></p>
    <canvas id="canvas" width="500" height="500"></canvas><br>
    <p id="fps"></p>
    <p id="latency"></p>
    <p id="error"></p>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script>
var socket = io();
var canvas = document.getElementById('canvas');
var ctx = canvas.getContext('2d');
ctx.font = '20px Arial';
var id = Math.random();
var ready = false;
var keysPressed = [];
var balls = {};
var frames = 0;
var iimage = {height:110,width:110};
document.getElementById('play').addEventListener('click', function(){
  var color = document.getElementById('color');
  socket.emit('newClient', [id, document.getElementById('nickname').value, color.options[color.selectedIndex].value]);
});
window.addEventListener('keyup', function(event){
  keysPressed.splice(keysPressed.indexOf(event.key),1);
  socket.emit('keyUpdate', keysPressed);
},false);
window.addEventListener('keydown', function(event){
  if(keysPressed.indexOf(event.key)==-1){keysPressed.push(event.key);}
  socket.emit('keyUpdate', keysPressed);
},false);
function Ball(id, name, color, x, y){
  if(!id){id = Math.random();}
  if(!color){color = 'red';}
  if(!x){x = 1;}
  if(!y){y = 1;}
  if(!name){name = '';}
  this.id = id;
  this.name = name;
  this.color = color;
  this.x = x;
  this.y = y;
  this.image = new Image();
  this.image.src = '/'+this.color+'.png';
  this.move = function(){
    ctx.drawImage(this.image, this.x, this.y);
    ctx.fillText(name, this.x+((iimage.height-ctx.measureText(name).width)/2), this.y+(iimage.width/2));
  }
  balls[id] = this;
}
socket.on('newClient', function(data){
  var loader = document.getElementById('loader');
  loader.style.visibility = 'hidden';
  loader.style.zIndex = -1;
  id = data.id;
  document.getElementById('id').innerHTML = 'ID: '+id;
  new Ball(data.id, data.name, data.color);
  ready = true;
});
socket.on('move', function(data){
  if(ready){
    ctx.clearRect(0,0,10000,10000);
    for(var id in data){
      new Ball(data[id].id, data[id].name, data[id].color, data[id].x, data[id].y);
      balls[id].move();
    }
  }
  frames++;
});
socket.on('adelete', function(data){
  delete balls[data];
});
setInterval(function(){
  var latency = 0;
  var startLatency = new Date();
  socket.emit('aping');
  socket.on('apong', function(){
    var nowLatency = new Date();
    latency = nowLatency.getTime()-startLatency.getTime();
    document.getElementById('latency').innerHTML = 'Latency: '+latency+'ms';
  });
},3000);
socket.on('bump', function(data){
  var sound = new Audio('bump'+data+'.mp3');
  sound.play();
});
setInterval(function(){
  if(frames==0){
    document.getElementById('error').innerHTML = 'Error: Lost connection with the server. Try reloading your page.';
  }
  document.getElementById('fps').innerHTML = 'FPS: '+frames;
  frames = 0;
},1000);
    </script>
  </body>
</html>