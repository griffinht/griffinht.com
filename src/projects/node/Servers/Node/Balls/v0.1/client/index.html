<!DOCTYPE html>
<html>
  <head>
    <title>Balls v0.1</title>
    <style>
#canvas {
  border: 2px solid black;
}
body {
  font-family: Arial;
}
    </style>
  </head>
  <body>
    <p id="id"></p>
    <canvas id="canvas" width="500" height="500"></canvas><br>
    <p id="fps"></p>
    <p id="latency"></p>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script>
var socket = io();
var canvas = document.getElementById('canvas');
var ctx = canvas.getContext('2d');
var id = Math.random();
var color = 'red';
var ready = false;
var keysPressed = [];
var balls = {};
var frames = 0;
window.addEventListener('keyup',function(event){
  keysPressed.splice(keysPressed.indexOf(event.key),1);
  socket.emit('keyUpdate',keysPressed);
},false);
window.addEventListener('keydown',function(event){
  if(keysPressed.indexOf(event.key)==-1){keysPressed.push(event.key);}
  socket.emit('keyUpdate',keysPressed);
},false);
function Ball(id, color, x ,y){
  if(!id){id = Math.random();}
  if(!color){color = 'red';}
  if(!x){x = 1;}
  if(!y){y = 1;}
  this.id = id;
  this.color = color;
  this.x = x;
  this.y = y;
  this.image = new Image();
  this.image.src = '/'+this.color+'.png';
  this.move = function(){ctx.drawImage(this.image, this.x, this.y);}
  balls[id] = this;
}
start();
function start(){
  socket.emit('newClient',[id,color]);
}
socket.on('newClient',function(data){
  id = data.id;
  document.getElementById('id').innerHTML = 'ID: '+id;
  new Ball(data.id, data.color);
  ready = true
});
socket.on('move',function(data){
  if(ready){
    ctx.clearRect(0,0,10000,10000);
    for(var id in data){
      new Ball(id, data[id].color, data[id].x, data[id].y);
      balls[id].move();
    }
  }
  frames++;
});
socket.on('adelete',function(data){
  delete balls[data];
});
setInterval(function(){
  var latency = 0;
  var startLatency = new Date();
  socket.emit('aping');
  socket.on('apong',function(){
    var nowLatency = new Date();
    latency = nowLatency.getTime()-startLatency.getTime();
    document.getElementById('latency').innerHTML = 'Latency: '+latency+'ms';
  });
},3000);
socket.on('bump',function(data){
  var sound = new Audio('bump'+data+'.mp3');
  sound.play();
});
setInterval(function(){
  document.getElementById('fps').innerHTML = 'FPS: '+frames;
  frames = 0;
},1000);
    </script>
  </body>
</html>