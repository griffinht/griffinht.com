<!DOCTYPE html>
<html>
  <head>
    <title>Balls v0.3</title>
    <style>
#canvas {
  border: 2px solid black;
  user-select: none;
}
body {
  font-family: Arial;
}
*:focus {
  outline: none;
}
#loader {
  position: absolute;
  left: 0px;
  top: 0px;
  width: 100%;
  height: 100%;
  z-index: 1;
  background-color: #ffffff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
#loader h1, #loader input, #loader select {
  border-radius: 10px;
  padding: 5px;
  font-size: 50px;
  font-family: sans-serif;
  margin: 5px;
  text-align: center;
}
    </style>
  </head>
  <body>
    <div id="loader">
      <h1 style="color: red;" id="death"></h1>
      <h1>Balls</h1>
      <input type="text" placeholder="Nickname" id="nickname"></input>
      <select name="color" id="color">
        <option value="red">Red</option>
        <option value="blue">Blue</option>
      </select>
      <input type="button" value="Play" id="play"></input>
    </div>
    <p id="id"></p>
    <canvas id="canvas" width="500" height="500"></canvas><br>
    <p id="fps"></p>
    <p id="latency"></p>
    <p id="error"></p>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script>
var socket = io();
var canvas = document.getElementById('canvas');
var ctx = canvas.getContext('2d');
ctx.font = '20px Arial';
var id = Math.random();
var ready = false;
var keysPressed = [];
var balls = {};
var frames = 0;
var bulletImage = new Image();
var first = true;
bulletImage.src = '/bullet.png';
var loader = document.getElementById('loader');
canvas.addEventListener('click',function(){socket.emit('newBullet');});
function newClient(){
  var color = document.getElementById('color');
  socket.emit('newClient',[document.getElementById('nickname').value, color.options[color.selectedIndex].value]);
}
document.getElementById('play').addEventListener('click',function(){newClient();});
window.addEventListener('keyup',function(event){
  keysPressed.splice(keysPressed.indexOf(event.key),1);
  socket.emit('keyUpdate',keysPressed);
},false);
window.addEventListener('keydown',function(event){
  if(keysPressed.indexOf(event.key)==-1){keysPressed.push(event.key);}
  socket.emit('keyUpdate',keysPressed);
},false);
socket.on('newClient',function(data){
  loader.style.visibility = 'hidden';
  loader.style.zIndex = -1;
  id = data.id;
  document.getElementById('id').innerHTML = 'ID: '+id;
  ready = true;
});
socket.on('move',function(data){
  if(ready){
    ctx.clearRect(0,0,10000,10000);
    var myId = id;
    var match = false;
    for(var id in data.balls){
      if(id==myId){match = true; first = false;}
      var ball = data.balls[id];
      image = new Image();
      image.src = '/'+ball.color+'.png';
      ctx.drawImage(image, ball.x, ball.y);
      ctx.fillText(ball.name, ball.x+((image.height-ctx.measureText(ball.name).width)/2), ball.y+(image.width/2));
      ctx.fillText(ball.health, ball.x+((image.height-ctx.measureText(ball.health).width)/2), ball.y+(image.width/1.25));
    }
    for(var id in data.bullets){
        var bullet = data.bullets[id];
        ctx.drawImage(bulletImage, bullet.x, bullet.y);
      }
  }
  frames++;
});
setInterval(function(){
  var latency = 0;
  var startLatency = new Date();
  socket.emit('aping');
  socket.on('apong',function(){
    var nowLatency = new Date();
    latency = nowLatency.getTime()-startLatency.getTime();
    document.getElementById('latency').innerHTML = 'Latency: '+latency+'ms';
  });
},3000);
socket.on('bump',function(data){
  var sound = new Audio('bump'+data+'.mp3');
  sound.play();
});
socket.on('death',function(data){
  ready = false;
  loader.style.visibility = 'visible';
  loader.style.zIndex = 1;
  document.getElementById('death').innerHTML = 'You died!';
});
setInterval(function(){
  if(frames==0){
    document.getElementById('error').innerHTML = 'Error: Lost connection with the server. Attempting to reconnect...';
    ready = false;
    var intervalId = setInterval(function(){
      if(ready){
        clearInterval(intervalId);
        return;
      }
      newClient();
    },1000);
  }else{document.getElementById('error').innerHTML = '';}
  document.getElementById('fps').innerHTML = 'FPS: '+frames;
  frames = 0;
},1000);
    </script>
  </body>
</html>